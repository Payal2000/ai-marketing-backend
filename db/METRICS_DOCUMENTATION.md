# E-Commerce Data Warehouse Metrics Documentation

## Overview

This document defines all metrics, their calculations, and relationships between data points across Shopify, Klaviyo, and Advertising platforms.

---

## 1. CUSTOMER METRICS

### Total Revenue
**Definition**: Sum of all paid orders for a customer  
**Formula**: `SUM(shopify_orders.total_price WHERE financial_status = 'paid')`  
**Stored In**: `customers.total_revenue`  
**Relationships**: 
- Aggregated from `shopify_orders`
- Updates when new orders are synced

### Average Order Value (AOV)
**Definition**: Average amount spent per order  
**Formula**: `Total Revenue / Total Orders`  
**Stored In**: `customers.average_order_value`  
**Function**: `calculate_aov(customer_uuid)`  
**Relationships**: 
- Calculated from `customers.total_revenue` and `customers.total_orders`
- Used in segmentation and customer value scoring

### Customer Lifetime Value (LTV/CLV)
**Definition**: Total revenue generated by a customer over their lifetime  
**Formula**: Same as `total_revenue` (synonymous for MVP)  
**Stored In**: `customers.total_revenue`  
**Future**: Can be enhanced with predicted LTV from Klaviyo (`klaviyo_predictive_metrics.predicted_lifetime_value`)

### Repeat Customer Rate
**Definition**: Percentage of customers who have placed more than one order  
**Formula**: `COUNT(DISTINCT customers WHERE total_orders > 1) / COUNT(DISTINCT customers)`  
**Query**:
```sql
SELECT 
  COUNT(*) FILTER (WHERE total_orders > 1)::decimal / COUNT(*) * 100 as repeat_rate
FROM customers
WHERE total_orders > 0;
```

### Days Since Last Order
**Definition**: Number of days since customer's most recent order  
**Formula**: `CURRENT_DATE - last_order_date`  
**Stored In**: Calculated in `customer_lifetime_metrics` view  
**Use Case**: Churn prediction, re-engagement campaigns

### First vs Returning Customer
**Definition**: Boolean flag indicating if customer has only one order  
**Stored In**: `customers.is_first_time_customer`  
**Computed**: `total_orders = 1` → first time, `total_orders > 1` → returning

---

## 2. ORDER METRICS

### Revenue by Source
**Definition**: Total revenue broken down by order source (online store, POS, etc.)  
**Query**:
```sql
SELECT 
  source,
  COUNT(*) as order_count,
  SUM(total_price) as revenue,
  AVG(total_price) as aov_by_source
FROM shopify_orders
WHERE financial_status = 'paid'
GROUP BY source;
```

### Refund Rate
**Definition**: Percentage of orders that were refunded  
**Formula**: `COUNT(orders WHERE refund_status IS NOT NULL) / COUNT(all orders) * 100`  
**Stored In**: Calculated from `shopify_orders.refund_status`  
**Use Case**: Quality control, product performance analysis

### Cancellation Rate
**Definition**: Percentage of orders that were cancelled  
**Formula**: `COUNT(orders WHERE cancelled_at IS NOT NULL) / COUNT(all orders) * 100`  
**Stored In**: `shopify_orders.cancelled_at`  
**Relationships**: Can be analyzed by source, payment method, or customer segment

---

## 3. PRODUCT METRICS

### Units Sold
**Definition**: Total quantity of a product/variant sold  
**Formula**: `SUM(shopify_order_line_items.quantity WHERE order.financial_status = 'paid')`  
**Stored In**: Calculated in `product_performance_summary` view  
**Relationships**: Links `shopify_products` → `shopify_order_line_items` → `shopify_orders`

### Product Revenue
**Definition**: Total revenue generated by a product  
**Formula**: `SUM(shopify_order_line_items.line_total WHERE order.financial_status = 'paid')`  
**Stored In**: `product_performance_summary.total_revenue`  
**Use Case**: Bestseller identification, inventory planning

### Product Conversion Rate
**Definition**: Percentage of product views that resulted in purchase  
**Formula**: `(Orders with product / Product views) * 100`  
**Calculation**:
```sql
SELECT 
  COUNT(DISTINCT order_id)::decimal / 
  COUNT(*) FILTER (WHERE event_type = 'product_viewed') * 100
FROM shopify_events
WHERE product_id = $1;
```
**Relationships**: Links `shopify_events` (views) → `shopify_order_line_items` (purchases)

### Gross Margin
**Definition**: Profit margin per product variant  
**Formula**: `(Revenue - Cost) / Revenue * 100`  
**Data Sources**: 
- Revenue: `shopify_order_line_items.line_total`
- Cost: `shopify_product_variants.cost`
**Use Case**: Profitability analysis, pricing optimization

### Inventory Turnover
**Definition**: How many times inventory is sold and replaced in a period  
**Formula**: `Units Sold / Average Inventory`  
**Data Sources**:
- Units Sold: From `shopify_order_line_items`
- Average Inventory: From `shopify_product_variants.inventory_quantity` (snapshots over time)

---

## 4. KLAVIYO EMAIL MARKETING METRICS

### Email Open Rate
**Definition**: Percentage of delivered emails that were opened  
**Formula**: `(unique_opens_count / delivered_count) * 100`  
**Stored In**: `klaviyo_campaigns` (calculated via `calculate_open_rate()` function)  
**Benchmark**: Industry average ~20-25%  
**Relationships**: Links `klaviyo_campaigns` → `klaviyo_events` (event_type = 'Opened Email')

### Email Click Rate
**Definition**: Percentage of delivered emails that received clicks  
**Formula**: `(unique_clicks_count / delivered_count) * 100`  
**Stored In**: `klaviyo_campaigns` (calculated via `calculate_click_rate()` function)  
**Benchmark**: Industry average ~2-3%  
**Relationships**: Links `klaviyo_campaigns` → `klaviyo_events` (event_type = 'Clicked Email')

### Unsubscribe Rate
**Definition**: Percentage of delivered emails that resulted in unsubscribes  
**Formula**: `(unsubscribes_count / delivered_count) * 100`  
**Stored In**: Calculated in `campaign_performance_summary` view  
**Use Case**: List health monitoring

### Revenue Per Recipient
**Definition**: Average revenue generated per email recipient  
**Formula**: `campaign_revenue / recipients_count`  
**Stored In**: `campaign_performance_summary.revenue_per_delivered`  
**Relationships**: 
- Links `klaviyo_campaigns.revenue` → attributed from `shopify_orders` within campaign timeframe

### Campaign ROI
**Definition**: Return on investment for a campaign  
**Formula**: `(Campaign Revenue - Campaign Cost) / Campaign Cost * 100`  
**Note**: Campaign cost not stored in schema (can add to `klaviyo_campaigns` if needed)

---

## 5. KLAVIYO FLOW/AUTOMATION METRICS

### Flow Conversion Rate
**Definition**: Percentage of flow recipients who converted (purchased)  
**Formula**: `(conversion_count / recipients_entered_count) * 100`  
**Stored In**: `klaviyo_flows` (calculated in queries)  
**Relationships**: Links `klaviyo_flows` → `klaviyo_flow_steps` → conversion events

### Flow Step Drop-off Rate
**Definition**: Percentage of recipients who exited flow at each step  
**Calculation**:
```sql
WITH step_recipients AS (
  SELECT 
    flow_id,
    step_order,
    recipients_count,
    LAG(recipients_count) OVER (PARTITION BY flow_id ORDER BY step_order) as prev_recipients
  FROM klaviyo_flow_steps
)
SELECT 
  flow_id,
  step_order,
  CASE 
    WHEN prev_recipients > 0 
    THEN (prev_recipients - recipients_count)::decimal / prev_recipients * 100
    ELSE 0
  END as drop_off_rate
FROM step_recipients;
```
**Use Case**: Optimization of email sequences

### Abandoned Cart Recovery Rate
**Definition**: Percentage of abandoned carts that were recovered via flow  
**Formula**: `(Recovered carts / Total abandoned carts) * 100`  
**Relationships**: 
- Abandoned carts: `shopify_events` WHERE `event_type = 'checkout_started'` AND no `checkout_completed`
- Recovered: Orders linked to flow entry events

---

## 6. KLAVIYO PREDICTIVE METRICS

### Predicted Next Order Date
**Definition**: AI-predicted date when customer will place next order  
**Stored In**: `klaviyo_predictive_metrics.predicted_next_order_date`  
**Source**: Klaviyo API predictions  
**Use Case**: Proactive inventory planning, personalized timing

### Predicted Churn Probability
**Definition**: Probability (0.0-1.0) that customer will churn  
**Stored In**: `klaviyo_predictive_metrics.predicted_churn_probability`  
**Use Case**: 
- High churn risk (>0.7) → Win-back campaigns
- Segmentation for retention flows

### Predicted Lifetime Value (PLTV)
**Definition**: AI-predicted total future value of customer  
**Stored In**: `klaviyo_predictive_metrics.predicted_lifetime_value`  
**Use Case**: Customer segmentation, acquisition cost justification

### Email Engagement Probability
**Definition**: Probability (0.0-1.0) that customer will engage with email  
**Stored In**: `klaviyo_predictive_metrics.email_engagement_probability`  
**Use Case**: Targeting for email campaigns, personalization

---

## 7. ADVERTISING METRICS

### CTR (Click-Through Rate)
**Definition**: Percentage of impressions that resulted in clicks  
**Formula**: `(clicks / impressions) * 100`  
**Stored In**: Calculated in queries from `ad_events`  
**Benchmark**: Varies by platform (Meta ~1-2%, Google ~2-3%)

### CPC (Cost Per Click)
**Definition**: Average cost per click  
**Formula**: `spend / clicks`  
**Calculation**:
```sql
SELECT 
  platform,
  campaign_id,
  CASE WHEN clicks > 0 THEN spend / clicks ELSE 0 END as cpc
FROM ad_events
WHERE clicks > 0;
```

### CPM (Cost Per Mille / Thousand Impressions)
**Definition**: Cost per 1,000 impressions  
**Formula**: `(spend / impressions) * 1000`  
**Use Case**: Media planning, budget allocation

### ROAS (Return on Ad Spend)
**Definition**: Revenue generated per dollar spent  
**Formula**: `revenue / spend`  
**Function**: `calculate_roas(ad_event_uuid)`  
**Benchmark**: Target > 3:1 (for most e-commerce)  
**Stored In**: Calculated in queries from `ad_events`  
**Relationships**: Links `ad_events.revenue` → `shopify_orders` (attributed via pixel/tracking)

### CAC (Customer Acquisition Cost)
**Definition**: Average cost to acquire one new customer  
**Formula**: `Total Ad Spend / New Customers Acquired`  
**Calculation**:
```sql
WITH ad_spend AS (
  SELECT SUM(spend) as total_spend
  FROM ad_events
  WHERE event_type = 'conversion'
),
new_customers AS (
  SELECT COUNT(DISTINCT customer_id) as count
  FROM ad_events
  WHERE event_type = 'conversion' AND customer_id IS NOT NULL
)
SELECT total_spend / count as cac
FROM ad_spend, new_customers;
```

---

## 8. ATTRIBUTION METRICS

### Last Touch Attribution
**Definition**: Credit last campaign/event before purchase  
**Query**:
```sql
SELECT 
  o.id as order_id,
  ke.event_type as last_touch,
  ke.occurred_at
FROM shopify_orders o
JOIN klaviyo_events ke ON ke.customer_id = o.customer_id
WHERE ke.event_type IN ('Opened Email', 'Clicked Email')
  AND ke.occurred_at < o.order_date
  AND ke.occurred_at >= o.order_date - INTERVAL '7 days'
ORDER BY ke.occurred_at DESC
LIMIT 1;
```

### First Touch Attribution
**Definition**: Credit first campaign/event in customer journey  
**Query**:
```sql
SELECT 
  o.id as order_id,
  ke.event_type as first_touch,
  MIN(ke.occurred_at) as first_touch_date
FROM shopify_orders o
JOIN klaviyo_events ke ON ke.customer_id = o.customer_id
WHERE ke.occurred_at <= o.order_date
GROUP BY o.id, ke.event_type
ORDER BY first_touch_date ASC
LIMIT 1;
```

### Multi-Touch Attribution
**Definition**: Credit distributed across all touchpoints  
**Models**: 
- **Linear**: Equal weight to all touches
- **Time Decay**: More weight to recent touches
- **Position-Based**: 40% first, 40% last, 20% middle
- **Data-Driven**: Based on conversion probability

---

## 9. DAILY AGGREGATION METRICS

### Customer Metrics Daily
**Purpose**: Pre-computed daily metrics for fast cohort analysis  
**Stored In**: `customer_metrics_daily`  
**Metrics**:
- `orders_count`: Orders placed that day
- `revenue`: Revenue generated that day
- `products_viewed_count`: Product pageviews
- `cart_adds_count`: Items added to cart
- `checkouts_started_count`: Checkout initiations
- `emails_opened_count`: Email opens
- `emails_clicked_count`: Email clicks

**Use Case**: 
- Cohort retention curves
- Customer journey visualization
- Daily active user analysis

### Campaign Performance Daily
**Purpose**: Daily breakdown of campaign metrics for trend analysis  
**Stored In**: `campaign_performance_daily`  
**Metrics**: Opens, clicks, unsubscribes, revenue per day  
**Use Case**: Campaign performance trends, time-of-day optimization

### Product Performance Daily
**Purpose**: Daily product metrics for inventory and conversion tracking  
**Stored In**: `product_performance_daily`  
**Metrics**: Views, cart adds, orders, units sold, revenue per day  
**Use Case**: Inventory forecasting, seasonal trend analysis

---

## 10. CROSS-SYSTEM RELATIONSHIPS

### Customer Journey Mapping
```
Customer Created (Shopify or Klaviyo)
  ↓
Product Views (shopify_events)
  ↓
Cart Adds (shopify_events)
  ↓
Checkout Started (shopify_events)
  ↓
Email Campaign (klaviyo_campaigns) → Email Opened/Clicked (klaviyo_events)
  ↓
Order Placed (shopify_orders)
  ↓
Fulfillment (shopify_orders.fulfillment_status)
  ↓
Post-Purchase Flow (klaviyo_flows)
```

### Attribution Flow
```
Ad Impression (ad_events)
  ↓
Ad Click (ad_events)
  ↓
Landing Page View (shopify_events)
  ↓
Email Signup (klaviyo_events)
  ↓
Email Campaign (klaviyo_campaigns)
  ↓
Email Click → Purchase (shopify_orders)
```

### Data Sync Points
- **Shopify → Customers**: `shopify_customer_id` links to `customers.shopify_customer_id`
- **Klaviyo → Customers**: `klaviyo_profile_id` links to `customers.klaviyo_profile_id`
- **Email → Order**: `klaviyo_events.event_type = 'Placed Order'` links to `shopify_orders.id`
- **Ad → Order**: `ad_events.order_id` links to `shopify_orders.id` (via pixel tracking)

---

## 11. KEY PERFORMANCE INDICATORS (KPIs)

### Business Health KPIs
1. **Total Revenue**: `SUM(shopify_orders.total_price WHERE financial_status = 'paid')`
2. **Monthly Recurring Revenue (MRR)**: For subscription products (if applicable)
3. **Customer Acquisition Cost (CAC)**: See Section 7
4. **Customer Lifetime Value (LTV)**: See Section 1
5. **LTV:CAC Ratio**: Target > 3:1

### Marketing KPIs
1. **Email List Growth Rate**: `(New subscribers - Unsubscribes) / Previous list size * 100`
2. **Campaign ROI**: See Section 4
3. **Flow Conversion Rate**: See Section 5
4. **Ad ROAS**: See Section 7

### Product KPIs
1. **Product Conversion Rate**: See Section 3
2. **Inventory Turnover**: See Section 3
3. **Gross Margin**: See Section 3
4. **Bestseller Rank**: By `total_units_sold` or `total_revenue`

---

## 12. QUERY EXAMPLES

### Customer Cohort Retention
```sql
SELECT 
  DATE_TRUNC('month', first_order_date) as cohort_month,
  EXTRACT(MONTH FROM AGE(date, first_order_date)) as months_since_first,
  COUNT(DISTINCT customer_id) as customers
FROM customer_metrics_daily cmd
JOIN customers c ON cmd.customer_id = c.id
WHERE c.first_order_date >= '2024-01-01'
GROUP BY cohort_month, months_since_first
ORDER BY cohort_month, months_since_first;
```

### Campaign Performance by Day of Week
```sql
SELECT 
  EXTRACT(DOW FROM date) as day_of_week,
  AVG(open_rate) as avg_open_rate,
  AVG(click_rate) as avg_click_rate,
  SUM(revenue) as total_revenue
FROM campaign_performance_summary cps
JOIN campaign_performance_daily cpd ON cps.campaign_id = cpd.campaign_id
GROUP BY day_of_week
ORDER BY day_of_week;
```

### Product Funnel Analysis
```sql
SELECT 
  sp.title,
  COUNT(DISTINCT se1.id) FILTER (WHERE se1.event_type = 'product_viewed') as views,
  COUNT(DISTINCT se2.id) FILTER (WHERE se2.event_type = 'cart_added') as cart_adds,
  COUNT(DISTINCT oli.order_id) as purchases
FROM shopify_products sp
LEFT JOIN shopify_events se1 ON se1.product_id = sp.id AND se1.event_type = 'product_viewed'
LEFT JOIN shopify_events se2 ON se2.product_id = sp.id AND se2.event_type = 'cart_added'
LEFT JOIN shopify_order_line_items oli ON oli.product_id = sp.id
GROUP BY sp.id, sp.title;
```

---

## 13. DATA QUALITY & VALIDATION

### Required Checks
1. **Customer Email Uniqueness**: Enforced by `customers.email UNIQUE` constraint
2. **Order Financial Status**: Should validate against enum: 'paid', 'pending', 'refunded', etc.
3. **Revenue Consistency**: `shopify_orders.total_price` should equal sum of `line_items.line_total`
4. **Event Timestamps**: `occurred_at` should be <= `created_at` for all events

### Data Freshness
- **Real-time**: Events (shopify_events, klaviyo_events)
- **Hourly Sync**: Orders, Products, Campaigns
- **Daily Aggregation**: customer_metrics_daily, campaign_performance_daily
- **Weekly**: Predictive metrics refresh

---

## 14. FUTURE ENHANCEMENTS

### Additional Metrics to Consider
1. **Subscription Metrics**: MRR, Churn Rate (for subscription products)
2. **A/B Test Results**: Campaign variant performance
3. **Device/Geo Segmentation**: Breakdown by device type, country
4. **UTM Tracking**: Enhanced source/medium tracking in event_properties
5. **Product Recommendations**: Based on purchase patterns
6. **Customer Satisfaction**: NPS scores, review ratings (if available)

### Schema Extensions
- Add `subscriptions` table for recurring revenue
- Add `ab_tests` table for campaign experiments
- Add `reviews` table for product ratings
- Extend `event_properties` with more structured JSONB schemas

